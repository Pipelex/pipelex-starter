domain      = "cv_and_offer"
description = "Analyzing CV and job offer compatibility and generating interview questions"
main_pipe   = "cv_job_match"

[concept]
CVAnalysis        = "Structured analysis of a candidate's curriculum vitae highlighting their professional profile."
JobRequirements   = "Structured analysis of a job offer detailing what the employer is seeking."
MatchAnalysis     = "Evaluation of how well a candidate aligns with job requirements."
InterviewQuestion = "A targeted question designed for a job interview with its underlying purpose."
InterviewSheet    = "A comprehensive interview preparation document combining match analysis with targeted interview questions."

[pipe.cv_job_match]
type = "PipeSequence"
description = """
Main pipeline that processes CV and job offer PDFs, analyzes their match, and generates targeted interview questions. This is the entry point for the CV-job matching method.
"""
inputs = { cv_pdf = "Document", job_offer_pdf = "Document" }
output = "InterviewSheet"
steps = [
  { pipe = "extract_documents", result = "extracted_documents" },
  { pipe = "analyze_documents", result = "analyzed_documents" },
  { pipe = "evaluate_match", result = "match_analysis" },
  { pipe = "generate_interview_questions", result = "interview_questions" },
  { pipe = "compose_interview_sheet", result = "interview_sheet" },
]

[pipe.extract_documents]
type = "PipeParallel"
description = "Extracts text content from both the CV and job offer PDFs concurrently"
inputs = { cv_pdf = "Document", job_offer_pdf = "Document" }
output = "Page[]"
branches = [
  { pipe = "extract_cv", result = "cv_pages" },
  { pipe = "extract_job_offer", result = "job_offer_pages" },
]
add_each_output = true

[pipe.extract_cv]
type        = "PipeExtract"
description = "Extracts text content from the CV PDF document"
inputs      = { cv_pdf = "Document" }
output      = "Page[]"
model       = "pdf_text_extractor"

[pipe.extract_job_offer]
type        = "PipeExtract"
description = "Extracts text content from the job offer PDF document"
inputs      = { job_offer_pdf = "Document" }
output      = "Page[]"
model       = "pdf_text_extractor"

[pipe.analyze_documents]
type = "PipeParallel"
description = "Analyzes both the CV and job offer documents concurrently to extract structured information"
inputs = { cv_pages = "Page", job_offer_pages = "Page" }
output = "Text"
branches = [
  { pipe = "analyze_cv", result = "cv_analysis" },
  { pipe = "analyze_job_offer", result = "job_requirements" },
]
add_each_output = true

[pipe.analyze_cv]
type = "PipeLLM"
description = """
Analyzes the CV to extract key information including skills, experience, education, previous roles, and notable achievements
"""
inputs = { cv_pages = "Page" }
output = "CVAnalysis"
model = "llm_to_answer_questions_cheap"
system_prompt = """
You are an expert HR analyst specializing in CV evaluation. Your task is to analyze curriculum vitae documents and extract structured information about candidates' professional profiles.
"""
prompt = """
Analyze the following CV and extract the candidate's key professional information.

@cv_pages
"""

[pipe.analyze_job_offer]
type = "PipeLLM"
description = """
Analyzes the job offer to extract requirements including required skills, preferred skills, responsibilities, qualifications, and experience level
"""
inputs = { job_offer_pages = "Page" }
output = "JobRequirements"
model = "llm_to_answer_questions_cheap"
system_prompt = """
You are an expert HR analyst specializing in job offer analysis. Your task is to extract and structure key requirements from job postings into a structured format.
"""
prompt = """
Analyze the following job offer and extract the key requirements for the position.

@job_offer_pages
"""

[pipe.evaluate_match]
type = "PipeLLM"
description = """
Evaluates how well the candidate matches the job requirements, identifying matching skills, gaps, experience alignment, and areas to explore during interview
"""
inputs = { cv_analysis = "CVAnalysis", job_requirements = "JobRequirements" }
output = "MatchAnalysis"
model = "llm_to_answer_questions_cheap"
system_prompt = """
You are an expert HR analyst and recruiter. Your task is to evaluate how well a candidate matches a job position by analyzing their CV against the job requirements. Provide a structured assessment that will help hiring managers make informed decisions.
"""
prompt = """
Evaluate how well the candidate matches the job requirements based on the following information:

**Candidate CV Analysis:**
@cv_analysis

**Job Requirements:**
@job_requirements

Analyze the alignment between the candidate's profile and the job requirements. Identify matching skills, missing skills, assess experience alignment, note any areas of concern, and highlight areas that should be explored further during the interview process. Provide an overall match score as a percentage.
"""

[pipe.generate_interview_questions]
type = "PipeLLM"
description = """
Creates 5 targeted interview questions based on the match analysis, focusing on verifying claimed skills, exploring gaps, and assessing cultural fit
"""
inputs = { cv_analysis = "CVAnalysis", job_requirements = "JobRequirements", match_analysis = "MatchAnalysis" }
output = "InterviewQuestion[5]"
model = "llm_to_answer_questions_cheap"
system_prompt = """
You are an expert HR interviewer and talent acquisition specialist. Your task is to generate structured interview questions that will help assess a candidate's fit for a specific role. Each question should be purposeful and designed to verify skills, explore potential gaps, or assess cultural fit.
"""
prompt = """
Based on the following candidate analysis, job requirements, and match analysis, generate 5 targeted interview questions.

@cv_analysis

@job_requirements

@match_analysis

Create questions that:
1. Verify the candidate's claimed skills and experience
2. Explore any identified gaps or areas of concern
3. Assess cultural and role fit
4. Investigate areas that warrant further exploration
"""

[pipe.compose_interview_sheet]
type = "PipeCompose"
description = """
Composes the final interview sheet by combining the match analysis results with the generated interview questions into a single structured document.
"""
inputs = { match_analysis = "MatchAnalysis", interview_questions = "InterviewQuestion[]" }
output = "InterviewSheet"

[pipe.compose_interview_sheet.construct]
overall_match_score  = { from = "match_analysis.overall_match_score" }
matching_skills      = { from = "match_analysis.matching_skills" }
missing_skills       = { from = "match_analysis.missing_skills" }
experience_alignment = { from = "match_analysis.experience_alignment" }
areas_of_concern     = { from = "match_analysis.areas_of_concern" }
areas_to_explore     = { from = "match_analysis.areas_to_explore" }
questions            = { from = "interview_questions" }
